(function(){POLARIS.dialog.add("blockcalculation",function(k){function v(a){function d(a){return a.type===POLARIS.NODE_ELEMENT&&a.is("p")}a=(a=a.plugins.tablecellblock)?a.getSelectedCells():[];var b=a[0]&&a[0].getAscendant("table"),g=POLARIS.tools.tableMap.findSplitedTables(b),l=b=NaN,c=NaN;if(a=function(a,b){for(var l=[],h=NaN,m=0,e=function(c){var e=a[c];c=e.getAttribute("data-split-id");var k="",n=0;if(-1<l.indexOf(c))return"continue";if(POLARIS.tools.isEmpty(c))k=e.$.innerText.trim().replace(/\u200b|,/g,
"");else{l.push(c);var f;POLARIS.tools.tableMap.findSplitedCells(e,g).forEach(function(a){if(!a.equals(e)){var b=a.getFirst(d);POLARIS.plugins.pagination.isSplitElement(f,b)||(k+="\n")}k+=a.$.innerText.trim().replace(/\u200b|,/g,"");f=a.getLast(d)})}k.split("\n").forEach(function(a){""!==a&&(n+=parseFloat(a),m+=1)});!isNaN(n)&&0<n&&(n=+n,h=isNaN(h)?n:b(h,n))},c=0;c<a.length;c+=1)e(c);return{result:h,count:0==m?NaN:m}}(a,function(a,b){return a+b}))b=a.result,c=a.count,l=(b/c).toFixed(4);return{sum:isNaN(b)?
"":b,avg:isNaN(l)?"":l,numCount:isNaN(c)?"":c}}var r="txtSum",q=function(){var a=this.getDialog();a.getContentElement("blockCalc","radioOption1")!=this&&a.getContentElement("blockCalc","radioOption1").setValue("");a.getContentElement("blockCalc","radioOption2")!=this&&a.getContentElement("blockCalc","radioOption2").setValue("");a.getContentElement("blockCalc","radioOption3")!=this&&a.getContentElement("blockCalc","radioOption3").setValue("");r=this.items[0][1]},f=k.lang.blockcalculation;POLARIS.getUrl(POLARIS.plugins.get("about").path+
"dialogs/"+(POLARIS.env.hidpi?"hidpi/":"")+"polaris_bi_info.png");return{title:f.label,minWidth:244,minHeight:115,resizable:POLARIS.DIALOG_RESIZE_NONE,contents:[{id:"blockCalc",label:"",padding:5,elements:[{type:"hbox",children:[{id:"radioOption1",type:"radio",order:"vertical",verticalalign:"top",items:[[f.labelSum,"txtSum"]],onClick:q},{id:"txtSum",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow;"}]},{type:"hbox",children:[{id:"radioOption2",type:"radio",
order:"vertical",verticalalign:"top",items:[[f.labelAvg,"txtAvg"]],onClick:q},{id:"txtAvg",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow;"}]},{type:"hbox",children:[{id:"radioOption3",type:"radio",order:"vertical",verticalalign:"top",items:[[f.labelLine,"txtLine"]],onClick:q},{id:"txtLine",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow; readOnly;"}]},{type:"hbox",className:"hbox_padding_zero",children:[{type:"checkbox",
id:"chkComma",label:f.labelComma,onClick:function(){var a=this.getDialog(),d=a.getContentElement("blockCalc","txtSum"),a=a.getContentElement("blockCalc","txtAvg");if(1==this.getValue()){var b=d.getValue().toString().split(".");d.setValue(b[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(b[1]?"."+b[1]:""));d=a.getValue().toString().split(".");a.setValue(d[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(d[1]?"."+d[1]:""))}else b=d.getValue().toString().split("."),d.setValue(b[0].replace(/[^\d]+/g,"")+(b[1]?"."+b[1]:
"")),d=a.getValue().toString().split("."),a.setValue(d[0].replace(/[^\d]+/g,"")+(d[1]?"."+d[1]:""))}}]}]}],onShow:function(){var a=this.getContentElement("blockCalc","txtSum"),d=this.getContentElement("blockCalc","txtAvg"),b=this.getContentElement("blockCalc","txtLine");this.getContentElement("blockCalc","chkComma");var g=a._.inputId;document.getElementById(g).readOnly=!0;g=d._.inputId;document.getElementById(g).readOnly=!0;g=b._.inputId;document.getElementById(g).readOnly=!0;a:{for(var g=k.getSelection().getRanges(),
l=0,c=0,f=0;f<g.length;f++){var q=new POLARIS.dom.walker(g[f]);if(0==q.range.endOffset-q.range.startOffset){g=v(k);a.setValue(g.sum);d.setValue(g.avg);b.setValue(g.numCount);break a}for(var p;p=q.next();)if(p.type==POLARIS.NODE_TEXT){p=p.getText();for(var h="",m="",e=!1,u=!1,t=0,f=0;f<p.length;f++)if(h=p.charAt(f),"0"<=h&&"9">=h||"."==h){if("."!=h)if(0==u)m=1==e?10*m+1*h:1*h;else if(1==e){for(var e=.1,r=0;r<t;r++)e*=.1;m+=h*e;t++}else m=1*h;else 1==e&&(u=!0);f==p.length-1&&(l+=m,c++);e=!0}else 1==
e&&(l+=m,c++,m=0),u=e=!1,t=0}}a.setValue(l);d.setValue(l/c);b.setValue(c)}a=k.plugins.blockcalculation.getOperation();"sum"==a?this.getContentElement("blockCalc","radioOption1").setValue("txtSum"):"avg"==a&&this.getContentElement("blockCalc","radioOption2").setValue("txtAvg")},buttons:[POLARIS.dialog.cancelButton(k,{label:k.lang.common.close})],onOk:function(){this.getContentElement("blockCalc",r).getSelection().getRanges().execCommand("Copy",!1,null)}}})})();